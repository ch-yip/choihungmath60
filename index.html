<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>彩天合60挑戰賽 | Math 60 Challenge</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts (Orbitron for tech/esports feel) -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#151e2e',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        gold: {
                            300: '#fde047',
                            400: '#facc15',
                            500: '#eab308',
                            600: '#ca8a04',
                        }
                    },
                    fontFamily: {
                        'tech': ['Orbitron', 'sans-serif'],
                        'body': ['Roboto', 'sans-serif'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'stamp': 'stamp-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'cursor-blink': 'cursor-blink 1s step-end infinite',
                    },
                    keyframes: {
                        'stamp-in': {
                            '0%': { transform: 'scale(3) rotate(-10deg)', opacity: '0' },
                            '100%': { transform: 'scale(1) rotate(-10deg)', opacity: '1' },
                        },
                        'cursor-blink': {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            color: white;
            font-family: 'Roboto', sans-serif;
            overflow-x: hidden;
        }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .gold-glow {
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.3);
        }
        
        .gold-text-glow {
            text-shadow: 0 0 10px rgba(250, 204, 21, 0.5);
        }

        .stamp-correct {
            border: 5px solid #22c55e;
            color: #22c55e;
            text-transform: uppercase;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 10px;
            font-family: 'Courier New', Courier, monospace;
            text-shadow: 0 0 5px #22c55e;
            box-shadow: inset 0 0 10px #22c55e;
            transform: rotate(-10deg);
        }

        .stamp-wrong {
            border: 5px solid #ef4444;
            color: #ef4444;
            text-transform: uppercase;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 10px;
            font-family: 'Courier New', Courier, monospace;
            text-shadow: 0 0 5px #ef4444;
            box-shadow: inset 0 0 10px #ef4444;
            transform: rotate(-10deg);
        }

        /* Card Styles */
        .playing-card {
            aspect-ratio: 2/3;
            background: white;
            color: black;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.5rem;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.2s;
            cursor: pointer;
            user-select: none;
        }
        
        .playing-card:hover {
            transform: translateY(-5px);
        }

        .playing-card.selected {
            border: 3px solid #facc15;
            box-shadow: 0 0 15px #facc15;
            transform: scale(1.05);
        }

        .playing-card.disabled {
            background: #94a3b8;
            color: #475569;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        /* Cursor Style */
        .equation-cursor {
            display: inline-block;
            width: 3px;
            height: 1.4em;
            background-color: #facc15;
            vertical-align: middle;
            margin: 0 1px;
            animation: cursor-blink 1s step-end infinite;
            box-shadow: 0 0 5px #facc15;
        }
        
        /* Token style for hit testing */
        .calc-token {
            display: inline-block;
            padding: 0 2px;
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="w-full bg-slate-950 border-b border-white/10 p-4 flex justify-between items-center z-50">
        <div class="flex items-center gap-3">
            <!-- Restored Calculator Icon -->
            <i class="fa-solid fa-calculator text-gold-400 text-3xl"></i>
            <h1 class="text-xl md:text-2xl font-tech font-bold text-transparent bg-clip-text bg-gradient-to-r from-gold-300 to-yellow-600 gold-text-glow">
                彩天合60挑戰賽
            </h1>
        </div>
        <!-- Enlarged User Info -->
        <div id="user-info" class="text-xl text-slate-300 hidden flex items-center gap-2">
            <span>玩家:</span> 
            <span id="display-username" class="text-white font-bold text-2xl drop-shadow-md"></span>
        </div>
    </nav>

    <!-- App Container -->
    <main id="app" class="flex-grow relative flex items-center justify-center p-4">
        
        <!-- View: Login / Welcome -->
        <div id="view-login" class="glass-panel p-8 rounded-2xl w-full max-w-md text-center transform transition-all duration-300">
            <h2 class="text-3xl font-tech mb-8 text-gold-400 font-bold">進入競技場</h2>
            <div class="space-y-6">
                <input type="text" id="input-username" placeholder="輸入您的暱稱" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-4 text-lg text-white focus:outline-none focus:border-gold-400 focus:ring-1 focus:ring-gold-400 transition">
                <button id="btn-login" disabled class="w-full bg-slate-700 text-slate-400 font-bold py-4 px-6 rounded-lg text-xl transition shadow-lg cursor-not-allowed">
                    <i class="fa-solid fa-spinner fa-spin mr-2"></i>連線中...
                </button>
            </div>
        </div>

        <!-- View: Lobby (Create/Join) -->
        <div id="view-lobby" class="hidden glass-panel p-8 rounded-2xl w-full max-w-lg text-center">
            <h2 class="text-2xl font-bold mb-6 text-slate-200">大廳選擇</h2>
            
            <div class="flex flex-col gap-6">
                <!-- Create Room -->
                <div class="border border-slate-700 rounded-xl p-4 bg-slate-800/50">
                    <h3 class="text-gold-400 font-bold mb-3 text-lg"><i class="fa-solid fa-plus-circle mr-2"></i>建立房間</h3>
                    <div class="space-y-3">
                        <input type="text" id="create-room-name" placeholder="房間名稱" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
                        <input type="password" id="create-room-pass" placeholder="密碼 (選填)" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
                        <button id="btn-create-room" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded transition text-lg">建立並加入</button>
                    </div>
                </div>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-slate-600"></div>
                    <span class="flex-shrink mx-4 text-slate-500 text-sm">或</span>
                    <div class="flex-grow border-t border-slate-600"></div>
                </div>

                <!-- Join Room -->
                <div class="border border-slate-700 rounded-xl p-4 bg-slate-800/50">
                    <h3 class="text-blue-400 font-bold mb-3 text-lg"><i class="fa-solid fa-right-to-bracket mr-2"></i>加入房間</h3>
                    <div class="space-y-3">
                        <input type="text" id="join-room-id" placeholder="輸入房間 ID 或名稱" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
                         <input type="password" id="join-room-pass" placeholder="密碼 (如有)" class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white">
                        <button id="btn-join-room" class="w-full bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 rounded transition text-lg">加入</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Waiting Room -->
        <div id="view-waiting" class="hidden glass-panel w-full max-w-4xl min-h-[500px] flex flex-col rounded-2xl overflow-hidden">
            <div class="bg-slate-900/80 p-6 border-b border-white/10 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-tech text-white" id="room-title-display">Room Name</h2>
                    <p class="text-slate-400 text-sm">Room ID: <span id="room-id-display" class="font-mono text-gold-400">...</span></p>
                </div>
                <div class="bg-indigo-900/50 px-4 py-2 rounded-full border border-indigo-500/30">
                    <i class="fa-solid fa-users text-indigo-400 mr-2"></i>
                    <span id="player-count" class="font-bold">0/6</span>
                </div>
            </div>

            <div class="flex-grow p-6 flex flex-col md:flex-row gap-6">
                <!-- Players Grid -->
                <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 content-start" id="waiting-player-list">
                    <!-- Player Cards Injected Here -->
                </div>
                
                <!-- Sidebar Actions -->
                <div class="w-full md:w-1/3 flex flex-col justify-end gap-4 border-t md:border-t-0 md:border-l border-white/10 pt-4 md:pt-0 md:pl-6">
                    <div class="bg-slate-800/50 p-4 rounded-lg text-sm text-slate-300">
                        <h4 class="font-bold text-white mb-2">規則簡介</h4>
                        <ul class="list-disc list-inside space-y-1">
                            <li>目標: 計算結果為 60</li>
                            <li>A=1, 必須使用所有5張卡牌</li>
                            <li>先搶答，限時30秒作答</li>
                            <li>當所有玩家都按下「沒有解」時，該回合便立即終止</li>
                            <li>4分勝出, 0分淘汰</li>
                        </ul>
                    </div>
                    
                    <button id="btn-ready" class="w-full py-4 rounded-xl font-bold text-lg bg-slate-700 hover:bg-slate-600 transition text-white border-2 border-slate-500">
                        準備
                    </button>
                    
                    <button id="btn-start-game" class="hidden w-full py-4 rounded-xl font-bold text-lg bg-gradient-to-r from-green-600 to-emerald-500 hover:from-green-500 hover:to-emerald-400 text-white shadow-lg shadow-green-500/20 animate-pulse">
                        開始比賽
                    </button>
                </div>
            </div>
        </div>

        <!-- View: Game Arena -->
        <div id="view-game" class="hidden w-full max-w-6xl flex flex-col gap-4 relative">
            
            <!-- Top Bar: Timer & Status -->
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Timer Dashboard -->
                <div class="glass-panel rounded-xl p-4 flex-grow flex items-center justify-between border-b-4 border-indigo-500 relative overflow-hidden">
                    <div class="absolute inset-0 bg-indigo-500/10 z-0"></div>
                    <div id="timer-progress" class="absolute left-0 bottom-0 h-1 bg-indigo-400 transition-all duration-1000 z-10" style="width: 100%"></div>
                    
                    <div class="relative z-20 flex items-center gap-4">
                        <div class="bg-slate-900 rounded-lg px-4 py-2 border border-slate-700">
                            <span class="text-xs text-slate-400 uppercase block">Round</span>
                            <span id="game-round" class="text-xl font-tech font-bold text-white">1</span>
                        </div>
                        <div class="text-left">
                            <div class="text-xs text-indigo-300 uppercase">Status</div>
                            <div id="game-status-text" class="text-lg font-bold text-white animate-pulse">ROUND START</div>
                        </div>
                    </div>

                    <div class="relative z-20">
                        <div class="text-4xl font-tech font-bold text-white tabular-nums tracking-wider" id="main-timer">60</div>
                    </div>
                </div>

                <!-- Impossible Button (Updated UI: Super Vivid Red & Glow) -->
                <div class="flex flex-col items-center">
                    <button id="btn-impossible" class="glass-panel rounded-xl p-4 bg-red-500 hover:bg-red-400 border-2 border-red-200 text-white transition flex flex-col items-center justify-center min-w-[140px] shadow-[0_0_30px_#ff0000] hover:shadow-[0_0_50px_#ff0000] transform hover:scale-105 active:scale-95 duration-150">
                        <i class="fa-solid fa-ban text-2xl mb-1 drop-shadow-md"></i>
                        <span class="text-sm font-bold uppercase tracking-wider drop-shadow-md">沒有解</span>
                        <span id="impossible-votes" class="text-xs mt-1 font-mono font-bold">0/0</span>
                    </button>
                    <span class="text-[12px] text-red-200 mt-2 max-w-[160px] text-center leading-tight font-bold drop-shadow-md">當所有玩家都按「沒有解」，本回合便會終止</span>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-4 items-start">
                
                <!-- Left: Players Stats -->
                <div class="w-full lg:w-1/4 grid grid-cols-2 lg:grid-cols-1 gap-2 order-2 lg:order-1" id="game-player-list">
                    <!-- Dynamic Player Stats -->
                </div>

                <!-- Center: Game Board -->
                <div class="w-full lg:w-1/2 glass-panel rounded-2xl p-6 min-h-[400px] flex flex-col items-center justify-center order-1 lg:order-2 relative bg-slate-900/50">
                    
                    <!-- REPLAY OVERLAY -->
                    <div id="replay-overlay" class="absolute inset-0 z-50 bg-slate-950/95 flex flex-col items-center justify-center hidden rounded-2xl">
                        <div class="text-gold-400 font-tech text-lg mb-8 tracking-widest border-b border-gold-400/30 pb-2">ACTION REPLAY</div>
                        
                        <!-- Cards move here dynamically -->
                        <div id="replay-cards-container" class="flex gap-2 mb-8 scale-75"></div>

                        <!-- Typewriter Equation -->
                        <div id="replay-equation" class="text-3xl md:text-5xl font-mono text-white mb-8 min-h-[60px]"></div>

                        <!-- Stamp -->
                        <div id="replay-stamp" class="opacity-0"></div>

                        <!-- Player Avatar/Name -->
                        <div id="replay-player-info" class="mt-8 flex items-center gap-3 text-slate-400">
                            <!-- Injected via JS -->
                        </div>

                        <!-- Host Control: Next Round & End Game -->
                        <div id="host-controls" class="mt-8 hidden flex gap-4">
                            <button id="btn-next-round" class="bg-gradient-to-r from-green-600 to-emerald-500 hover:from-green-500 hover:to-emerald-400 text-white font-bold py-3 px-8 rounded-full shadow-lg transition animate-pulse text-lg">
                                下一回合 <i class="fa-solid fa-arrow-right ml-2"></i>
                            </button>
                            <button id="btn-terminate-game-overlay" class="bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white font-bold py-3 px-8 rounded-full shadow-lg transition text-lg">
                                結束遊戲 <i class="fa-solid fa-flag-checkered ml-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Cards Area -->
                    <div class="w-full mb-8">
                        <div id="cards-container" class="flex justify-center gap-2 md:gap-4 flex-wrap">
                            <!-- Cards Generated Here -->
                        </div>
                    </div>

                    <!-- Buzz Button (Overlay when not my turn) -->
                    <div id="buzz-container" class="w-full flex justify-center py-8">
                        <button id="btn-buzz" class="rounded-full w-32 h-32 md:w-40 md:h-40 bg-gradient-to-br from-indigo-600 to-blue-700 hover:from-indigo-500 hover:to-blue-600 shadow-[0_0_30px_rgba(79,70,229,0.5)] border-4 border-indigo-400 text-white font-bold text-2xl font-tech uppercase tracking-widest transition-all transform active:scale-95 animate-pulse">
                            搶答
                        </button>
                    </div>

                    <!-- Calculator Interface (Only visible to active player) -->
                    <div id="calc-interface" class="w-full hidden flex-col gap-4">
                        <!-- Equation Display with Clickable Cursor Support -->
                        <div id="current-equation-html" class="bg-black/40 border border-slate-600 rounded-lg p-4 min-h-[60px] flex items-center justify-start overflow-hidden cursor-text select-none text-2xl font-mono text-gold-400 tracking-wider" onclick="game.handleEquationClick(event)" ontouchend="game.handleEquationClick(event)">
                            <!-- Equation and Cursor will be rendered here dynamically -->
                        </div>

                        <!-- Operators & Controls -->
                        <div class="grid grid-cols-4 gap-2">
                            <button class="calc-btn op-btn bg-slate-700 hover:bg-slate-600 text-white rounded p-3 font-bold text-xl" data-val="+">+</button>
                            <button class="calc-btn op-btn bg-slate-700 hover:bg-slate-600 text-white rounded p-3 font-bold text-xl" data-val="-">-</button>
                            <button class="calc-btn op-btn bg-slate-700 hover:bg-slate-600 text-white rounded p-3 font-bold text-xl" data-val="*">×</button>
                            <button class="calc-btn op-btn bg-slate-700 hover:bg-slate-600 text-white rounded p-3 font-bold text-xl" data-val="/">÷</button>
                            
                            <button class="calc-btn op-btn bg-slate-700 hover:bg-slate-600 text-white rounded p-3 font-bold text-xl" data-val="(">(</button>
                            <button class="calc-btn op-btn bg-slate-700 hover:bg-slate-600 text-white rounded p-3 font-bold text-xl" data-val=")">)</button>
                            
                            <!-- Arrow Keys for Cursor -->
                            <button class="calc-btn bg-slate-600 hover:bg-slate-500 text-white rounded p-3 font-bold text-xl" onclick="game.moveCursor(-1)"><i class="fa-solid fa-arrow-left"></i></button>
                            <button class="calc-btn bg-slate-600 hover:bg-slate-500 text-white rounded p-3 font-bold text-xl" onclick="game.moveCursor(1)"><i class="fa-solid fa-arrow-right"></i></button>

                            <button class="calc-btn bg-red-900/50 hover:bg-red-800 text-red-200 rounded p-3 font-bold col-span-2" onclick="game.clearEquation()">CLR</button>
                            <button class="calc-btn bg-slate-700 hover:bg-slate-600 text-white rounded p-3 font-bold col-span-2" onclick="game.backspace()"><i class="fa-solid fa-delete-left"></i></button>
                        </div>
                        
                        <button id="btn-submit" class="w-full bg-gold-500 hover:bg-gold-400 text-black font-bold py-3 rounded-lg text-xl uppercase tracking-wider shadow-lg">
                            提交 (60)
                        </button>
                    </div>

                </div>

                <!-- Right: Game Log / Chat (Optional, but good for context) -->
                <div class="w-full lg:w-1/4 glass-panel rounded-xl p-4 h-[400px] flex flex-col order-3 relative">
                     <!-- Immediate End Game Button for Host (Always visible in game view) -->
                    <button id="btn-terminate-game-main" class="hidden w-full mb-4 bg-red-900/80 hover:bg-red-800 border border-red-500 text-red-200 font-bold py-2 px-4 rounded-lg transition text-sm">
                        <i class="fa-solid fa-power-off mr-2"></i>立即終結遊戲
                    </button>

                    <h3 class="text-slate-400 font-bold mb-2 text-sm uppercase">戰況紀錄</h3>
                    <div id="game-logs" class="flex-grow overflow-y-auto space-y-2 text-sm font-mono custom-scrollbar pr-2">
                        <!-- Logs -->
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Game Over -->
        <div id="view-gameover" class="hidden glass-panel p-10 rounded-2xl w-full max-w-lg text-center absolute z-50">
            <i class="fa-solid fa-trophy text-6xl text-gold-400 mb-6 drop-shadow-[0_0_15px_rgba(250,204,21,0.5)]"></i>
            <h2 class="text-4xl font-tech font-bold text-white mb-2">比賽結束</h2>
            <div id="winner-display" class="text-2xl text-gold-300 font-bold mb-8">Winner Name</div>
            
            <button onclick="location.reload()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-8 rounded-full shadow-lg transition">
                回到大廳
            </button>
        </div>

    </main>

    <!-- Modal for Messages -->
    <div id="modal-msg" class="fixed inset-0 bg-black/80 hidden z-[100] flex items-center justify-center">
        <div class="bg-slate-800 p-6 rounded-xl max-w-sm w-full text-center border border-slate-600">
            <p id="modal-text" class="text-white mb-4">Message</p>
            <button onclick="document.getElementById('modal-msg').classList.add('hidden')" class="bg-slate-600 px-4 py-2 rounded text-white">關閉</button>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, arrayUnion, arrayRemove, increment, getDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Configuration
        const firebaseConfig = {
            apiKey: "", 
            authDomain: "choihungmath60.firebaseapp.com",
            projectId: "choihungmath60",
            storageBucket: "choihungmath60.firebasestorage.app",
            messagingSenderId: "776665273170",
            appId: "1:776665273170:web:b0bba56f0beeb4dade608b",
            measurementId: "G-5JX2113RF9"
        };
        
        const finalConfig = {
            ...firebaseConfig,
            apiKey: "AIzaSyAsHxYaXWQkLDlfGvPjA4c5a-Z2nII41Fc"
        };

        const app = initializeApp(finalConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');

        let currentUser = null;
        let currentRoomId = null;
        let roomUnsubscribe = null;
        let roomState = null;
        let myCards = []; 
        let usedCardsIndices = [];
        let equationString = "";
        let equationHistory = []; // Stores objects { type: 'card'|'op', val: string, cardIdx?: number }
        let timerInterval = null; 
        let cursorPos = 0; // New: Cursor Position (0 to length)

        // --- Auth Guard ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Failed", error);
                alert("連線失敗，請重新整理");
            }
        };
        initAuth();

        // --- Helper Function for Firestore Paths ---
        function getRoomRef(roomId) {
            const safeId = encodeURIComponent(roomId);
            return doc(db, 'artifacts', appId, 'public', 'data', 'rooms', safeId);
        }

        // --- DOM Elements ---
        const views = {
            login: document.getElementById('view-login'),
            lobby: document.getElementById('view-lobby'),
            waiting: document.getElementById('view-waiting'),
            game: document.getElementById('view-game'),
            gameover: document.getElementById('view-gameover')
        };

        // --- Auth & Init ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const btnLogin = document.getElementById('btn-login');
                btnLogin.disabled = false;
                btnLogin.innerHTML = "開始遊戲";
                btnLogin.classList.remove('bg-slate-700', 'text-slate-400', 'cursor-not-allowed');
                btnLogin.classList.add('bg-gradient-to-r', 'from-gold-600', 'to-yellow-500', 'text-slate-950', 'hover:scale-105');

                if (localStorage.getItem('playerName')) {
                    currentUser.displayName = localStorage.getItem('playerName');
                    document.getElementById('display-username').innerText = currentUser.displayName;
                    document.getElementById('user-info').classList.remove('hidden');
                    showView('lobby');
                }
            }
        });

        document.getElementById('btn-login').addEventListener('click', () => {
            if (!currentUser) return; 
            const name = document.getElementById('input-username').value.trim();
            if (!name) return alert("請輸入暱稱");
            localStorage.setItem('playerName', name);
            if (currentUser) currentUser.displayName = name;
            document.getElementById('display-username').innerText = name;
            document.getElementById('user-info').classList.remove('hidden');
            showView('lobby');
        });

        // --- Lobby Logic ---
        document.getElementById('btn-create-room').addEventListener('click', async () => {
            if (!currentUser) return alert("尚未連線，請稍候");
            const name = document.getElementById('create-room-name').value.trim();
            if (!name) return alert("請輸入房間名稱");
            const pass = document.getElementById('create-room-pass').value.trim();
            
            const roomId = name; 
            const roomRef = getRoomRef(roomId);
            
            try {
                const docSnap = await getDoc(roomRef);
                if (docSnap.exists()) return alert("房間名稱已存在，請更換");

                await setDoc(roomRef, {
                    hostId: currentUser.uid,
                    password: pass,
                    status: 'waiting',
                    round: 0,
                    players: [{
                        id: currentUser.uid,
                        name: currentUser.displayName || 'Player',
                        score: 2, 
                        ready: false,
                        status: 'active', 
                        avatar: Math.floor(Math.random() * 5) + 1
                    }],
                    cards: [],
                    currentBuzzer: null,
                    buzzerTime: null,
                    roundEndTime: null, 
                    answerEndTime: null, 
                    impossibleVotes: [],
                    lastResult: null, 
                    createdAt: serverTimestamp()
                });
                joinRoomLogic(roomId);
            } catch (e) {
                console.error("Create Room Error:", e);
                alert("建立失敗: " + e.message);
            }
        });

        document.getElementById('btn-join-room').addEventListener('click', async () => {
            if (!currentUser) return alert("尚未連線，請稍候");
            const roomId = document.getElementById('join-room-id').value.trim();
            const pass = document.getElementById('join-room-pass').value.trim();
            if (!roomId) return;

            const roomRef = getRoomRef(roomId);
            try {
                const docSnap = await getDoc(roomRef);
                if (!docSnap.exists()) return alert("房間不存在");
                const data = docSnap.data();
                if (data.password && data.password !== pass) return alert("密碼錯誤");
                if (data.status !== 'waiting') return alert("遊戲已開始");
                if (data.players.length >= 6) return alert("房間已滿");
                if (data.players.find(p => p.id === currentUser.uid)) {
                    joinRoomLogic(roomId); 
                    return;
                }

                await updateDoc(roomRef, {
                    players: arrayUnion({
                        id: currentUser.uid,
                        name: currentUser.displayName || 'Player',
                        score: 2,
                        ready: false,
                        status: 'active',
                        avatar: Math.floor(Math.random() * 5) + 1
                    })
                });
                joinRoomLogic(roomId);
            } catch (e) {
                console.error("Join Room Error:", e);
                alert("加入失敗，請重試");
            }
        });

        function joinRoomLogic(roomId) {
            currentRoomId = roomId;
            if (roomUnsubscribe) roomUnsubscribe();
            
            const roomRef = getRoomRef(roomId);
            roomUnsubscribe = onSnapshot(roomRef, (snapshot) => {
                if (!snapshot.exists()) {
                    alert("房間已解散");
                    location.reload();
                    return;
                }
                const data = snapshot.data();
                roomState = data;
                renderRoom(data);
            }, (error) => {
                console.error("Snapshot Error:", error);
            });
        }

        // --- Timer Loop Logic ---
        function startTimerLoop() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!roomState) return;
                
                if (roomState.status !== 'playing') {
                     document.getElementById('main-timer').innerText = "0";
                     document.getElementById('timer-progress').style.width = "0%";
                     return;
                }

                const now = new Date().getTime();
                let remaining = 0;
                let total = 60;
                
                const isSomeoneBuzzing = roomState.currentBuzzer !== null;

                if (isSomeoneBuzzing) {
                    if (roomState.answerEndTime) {
                        remaining = Math.max(0, Math.ceil((roomState.answerEndTime.toMillis() - now) / 1000));
                        total = 30; 
                    }
                } else {
                    if (roomState.roundEndTime) {
                        remaining = Math.max(0, Math.ceil((roomState.roundEndTime.toMillis() - now) / 1000));
                        total = 60;
                    }
                }

                document.getElementById('main-timer').innerText = remaining;
                const pct = (remaining / total) * 100;
                const progressBar = document.getElementById('timer-progress');
                progressBar.style.width = `${pct}%`;
                progressBar.className = remaining < 10 
                    ? "absolute left-0 bottom-0 h-1 bg-red-500 transition-all duration-300 z-10" 
                    : "absolute left-0 bottom-0 h-1 bg-indigo-400 transition-all duration-300 z-10";
                
                if (currentUser && roomState.hostId === currentUser.uid && remaining === 0) {
                     if (isSomeoneBuzzing) {
                         handleRoundResult('timeout', roomState.currentBuzzer);
                     } else {
                         handleRoundResult('impossible', null);
                     }
                }

            }, 1000); 
        }

        // --- Rendering & Game Loop ---
        function renderRoom(data) {
            // Check for Impossible condition inside render to catch all updates
            if (currentUser && data.hostId === currentUser.uid && data.status === 'playing') {
                const activeCount = data.players.filter(p => p.status === 'active').length;
                if (data.impossibleVotes && data.impossibleVotes.length >= activeCount && activeCount > 0) {
                    handleRoundResult('impossible', null);
                }
            }

            if (data.status === 'waiting') {
                showView('waiting');
                renderWaitingRoom(data);
                if (timerInterval) clearInterval(timerInterval);
            } else if (data.status === 'playing' || data.status === 'replay') {
                showView('game');
                renderGame(data);
                if (!timerInterval) startTimerLoop();
            } else if (data.status === 'finished') {
                showView('gameover');
                if (timerInterval) clearInterval(timerInterval);
                const winner = data.players.reduce((prev, current) => (prev.score > current.score) ? prev : current);
                document.getElementById('winner-display').innerText = winner.name + " (Score: " + winner.score + ")";
            }
        }

        // --- Waiting Room Logic ---
        function renderWaitingRoom(data) {
            document.getElementById('room-title-display').innerText = currentRoomId;
            document.getElementById('room-id-display').innerText = currentRoomId;
            document.getElementById('player-count').innerText = `${data.players.length}/6`;
            
            const container = document.getElementById('waiting-player-list');
            container.innerHTML = '';
            
            let allReady = true;
            data.players.forEach(p => {
                const isMe = p.id === currentUser.uid;
                if (!p.ready) allReady = false;
                
                const card = document.createElement('div');
                card.className = `p-4 rounded-xl border flex items-center justify-between ${p.ready ? 'bg-indigo-900/40 border-indigo-500' : 'bg-slate-800 border-slate-700'}`;
                card.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xl">
                            <i class="fa-solid fa-user-astronaut text-slate-400"></i>
                        </div>
                        <span class="font-bold text-white">${p.name} ${isMe ? '(我)' : ''}</span>
                        ${p.id === data.hostId ? '<i class="fa-solid fa-crown text-gold-400 ml-1" title="Host"></i>' : ''}
                    </div>
                    <div class="${p.ready ? 'text-green-400' : 'text-slate-500'} font-bold">
                        ${p.ready ? 'READY' : 'WAITING'}
                    </div>
                `;
                container.appendChild(card);
            });

            const me = data.players.find(p => p.id === currentUser.uid);
            const btnReady = document.getElementById('btn-ready');
            btnReady.innerText = me.ready ? "取消準備" : "準備";
            btnReady.className = me.ready 
                ? "w-full py-4 rounded-xl font-bold text-lg bg-slate-600 text-slate-300 border-2 border-slate-500"
                : "w-full py-4 rounded-xl font-bold text-lg bg-indigo-600 hover:bg-indigo-500 text-white border-2 border-indigo-400 shadow-[0_0_15px_rgba(79,70,229,0.3)] transition";

            const btnStart = document.getElementById('btn-start-game');
            if (currentUser.uid === data.hostId) {
                btnStart.classList.remove('hidden');
                if (allReady && data.players.length > 1) {
                    btnStart.disabled = false;
                    btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    btnStart.disabled = true;
                    btnStart.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } else {
                btnStart.classList.add('hidden');
            }
        }

        document.getElementById('btn-ready').addEventListener('click', async () => {
            if (!currentRoomId || !roomState) return;
            const roomRef = getRoomRef(currentRoomId);
            const me = roomState.players.find(p => p.id === currentUser.uid);
            const updatedPlayers = roomState.players.map(p => {
                if (p.id === currentUser.uid) return { ...p, ready: !p.ready };
                return p;
            });
            await updateDoc(roomRef, { players: updatedPlayers });
        });

        document.getElementById('btn-start-game').addEventListener('click', async () => {
            startNewRound(currentRoomId, 1);
        });

        document.getElementById('btn-next-round').addEventListener('click', async () => {
             if (!currentRoomId || !roomState) return;
             const winner = roomState.players.find(p => p.score >= 4);
             const activePlayers = roomState.players.filter(p => p.status === 'active');
             
             const roomRef = getRoomRef(currentRoomId);

             if (winner || activePlayers.length <= 1) {
                 await updateDoc(roomRef, { status: 'finished' });
             } else {
                 startNewRound(currentRoomId, roomState.round + 1);
             }
        });

        const terminateGame = async () => {
            if (!currentRoomId || !roomState) return;
             if (!confirm("確定要立即結束遊戲嗎？")) return;
             
             const roomRef = getRoomRef(currentRoomId);
             await updateDoc(roomRef, { status: 'finished' });
        };
        document.getElementById('btn-terminate-game-main').addEventListener('click', terminateGame);
        document.getElementById('btn-terminate-game-overlay').addEventListener('click', terminateGame);

        // --- Game Logic ---
        async function startNewRound(roomId, roundNum) {
            const cards = [];
            for(let i=0; i<5; i++) cards.push(Math.floor(Math.random() * 10) + 1);
            
            const future = new Date();
            future.setSeconds(future.getSeconds() + 62); 

            const roomRef = getRoomRef(roomId);
            await updateDoc(roomRef, {
                status: 'playing',
                round: roundNum,
                cards: cards,
                currentBuzzer: null,
                buzzerTime: null,
                roundEndTime: future,
                answerEndTime: null,
                impossibleVotes: [],
                lastResult: null
            });
        }

        function renderGame(data) {
            const replayOverlay = document.getElementById('replay-overlay');
            const hostControls = document.getElementById('host-controls');
            const terminateBtnMain = document.getElementById('btn-terminate-game-main');
            const buzzContainer = document.getElementById('buzz-container'); // Fix 1: Ref for UI update

            if (currentUser.uid === data.hostId) {
                terminateBtnMain.classList.remove('hidden');
            } else {
                terminateBtnMain.classList.add('hidden');
            }

            if (data.status === 'replay' && data.lastResult) {
                replayOverlay.classList.remove('hidden');
                
                if (currentUser.uid === data.hostId) {
                    hostControls.classList.remove('hidden');
                } else {
                    hostControls.classList.add('hidden');
                }
                playReplay(data);
            } else {
                replayOverlay.classList.add('hidden');
                hostControls.classList.add('hidden');
            }

            const me = data.players.find(p => p.id === currentUser.uid);
            const isMyTurn = data.currentBuzzer === currentUser.uid;
            const isSomeoneBuzzing = data.currentBuzzer !== null;
            
            document.getElementById('game-round').innerText = data.round;
            document.getElementById('game-status-text').innerText = isSomeoneBuzzing 
                ? (isMyTurn ? "回答中!" : "玩家回答中...") 
                : "搶答階段";
            document.getElementById('game-status-text').className = isSomeoneBuzzing 
                ? "text-lg font-bold text-red-400 animate-pulse" 
                : "text-lg font-bold text-green-400";

            const cardsContainer = document.getElementById('cards-container');
            cardsContainer.innerHTML = '';
            
            data.cards.forEach((val, idx) => {
                const card = document.createElement('div');
                const isUsed = isMyTurn && usedCardsIndices.includes(idx);
                
                card.className = `playing-card w-16 h-24 md:w-20 md:h-28 text-2xl md:text-4xl rounded-lg shadow-lg flex items-center justify-center font-bold select-none transition-all
                    ${isUsed ? 'disabled opacity-20 transform scale-90' : 'bg-slate-100 text-slate-900 hover:-translate-y-1'}`;
                
                const suits = ['♠', '♥', '♣', '♦'];
                const suit = suits[idx % 4];
                const color = (idx % 4 === 1 || idx % 4 === 3) ? 'text-red-600' : 'text-slate-900';
                
                card.innerHTML = `
                    <div class="${color}">${val === 1 ? 'A' : val}</div>
                    <div class="absolute top-1 left-1 text-xs ${color}">${suit}</div>
                    <div class="absolute bottom-1 right-1 text-xs ${color} transform rotate-180">${suit}</div>
                `;
                
                if (isMyTurn && !isUsed) {
                    card.onclick = () => addToEquation(val, idx);
                }
                cardsContainer.appendChild(card);
            });

            const calcInterface = document.getElementById('calc-interface');
            const impossibleBtn = document.getElementById('btn-impossible');

            // Fix 1: Strict Elimination UI Check
            if (me.status !== 'active') {
                buzzContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-32 md:h-40">
                        <i class="fa-solid fa-skull-crossbones text-4xl text-gray-500 mb-2"></i>
                        <span class="text-gray-500 font-bold text-xl uppercase tracking-widest">已淘汰</span>
                    </div>
                `;
                buzzContainer.classList.remove('hidden');
                calcInterface.classList.add('hidden');
                impossibleBtn.disabled = true;
                impossibleBtn.classList.add('opacity-30', 'grayscale');
            } else {
                // Active player logic - IMPOSSIBLE BUTTON HANDLING MOVED HERE (GLOBAL FOR ACTIVE)
                
                // Update text regardless of state
                impossibleBtn.querySelector('span:last-child').innerText = `${data.impossibleVotes.length}/${data.players.filter(p=>p.status==='active').length}`;

                // Check if already voted OR if I am currently answering (isMyTurn) - Fix: Buzzing player cannot press Impossible
                if (data.impossibleVotes.includes(currentUser.uid) || isMyTurn) {
                    impossibleBtn.disabled = true;
                    impossibleBtn.classList.add('opacity-50');
                    impossibleBtn.classList.remove('hover:scale-105', 'active:scale-95', 'shadow-[0_0_30px_#ff0000]', 'hover:shadow-[0_0_50px_#ff0000]'); // Remove glow if voted/busy
                } else {
                    // Not voted and not answering - Keep it BRIGHT and ACTIVE at all times
                    impossibleBtn.disabled = false;
                    impossibleBtn.classList.remove('opacity-50', 'opacity-30', 'grayscale');
                }

                // BUZZER / CALC LOGIC
                if (!isSomeoneBuzzing) {
                    buzzContainer.innerHTML = `
                        <button id="btn-buzz" class="rounded-full w-32 h-32 md:w-40 md:h-40 bg-gradient-to-br from-indigo-600 to-blue-700 hover:from-indigo-500 hover:to-blue-600 shadow-[0_0_30px_rgba(79,70,229,0.5)] border-4 border-indigo-400 text-white font-bold text-2xl font-tech uppercase tracking-widest transition-all transform active:scale-95 animate-pulse">
                            搶答
                        </button>
                    `;
                    document.getElementById('btn-buzz').addEventListener('click', onBuzzClick);

                    buzzContainer.classList.remove('hidden');
                    calcInterface.classList.add('hidden');
                } else {
                    buzzContainer.classList.add('hidden');
                    
                    if (isMyTurn) {
                        calcInterface.classList.remove('hidden');
                    } else {
                        calcInterface.classList.add('hidden');
                        const buzzerName = data.players.find(p => p.id === data.currentBuzzer)?.name;
                        cardsContainer.innerHTML += `<div class="w-full text-center text-yellow-400 font-bold mt-4 animate-pulse">${buzzerName} 正在計算中...</div>`;
                    }
                }
            }

            const pList = document.getElementById('game-player-list');
            pList.innerHTML = '';
            
            const sortedPlayers = [...data.players].sort((a,b) => b.score - a.score);
            const leaderScore = sortedPlayers[0].score;

            sortedPlayers.forEach(p => {
                const isActive = p.status === 'active';
                const isLeader = p.score === leaderScore && p.score > 2;
                const isBuzzing = p.id === data.currentBuzzer;
                
                const div = document.createElement('div');
                div.className = `relative p-3 rounded-lg border flex flex-col justify-between transition-all duration-300
                    ${isLeader ? 'bg-indigo-900/60 border-gold-500 shadow-[0_0_10px_rgba(250,204,21,0.3)]' : 'bg-slate-800/80 border-slate-700'}
                    ${isBuzzing ? 'ring-2 ring-red-500 scale-105 z-10' : ''}
                    ${!isActive ? 'opacity-50 grayscale' : ''}
                `;
                
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-white truncate text-sm">${p.name}</span>
                        ${isLeader ? '<i class="fa-solid fa-crown text-gold-400 text-xs"></i>' : ''}
                        ${!isActive ? '<span class="text-xs text-red-500 font-bold">OUT</span>' : ''}
                    </div>
                    <div class="flex justify-between items-end">
                        <div class="text-xs text-slate-400">PTS</div>
                        <div class="text-2xl font-tech font-bold ${p.score >= 3 ? 'text-green-400' : (p.score <= 1 ? 'text-red-400' : 'text-blue-400')}">${p.score}</div>
                    </div>
                    ${isBuzzing ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-ping"></div>' : ''}
                `;
                pList.appendChild(div);
            });
        }

        // --- Interaction Logic ---
        
        // Define buzz handler function so we can re-attach it easily
        async function onBuzzClick() {
            if (!currentRoomId || !roomState) return;
            
            // Double check elimination status locally
            const me = roomState.players.find(p => p.id === currentUser.uid);
            if (me.status !== 'active') {
                showToast("你已被淘汰，無法搶答！");
                return;
            }

            if (roomState.currentBuzzer !== null) return;

            const roomRef = getRoomRef(currentRoomId);
            
            equationHistory = []; // Reset history
            cursorPos = 0; // Reset cursor
            updateCalcState();    // Reset visual state

            try {
                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(roomRef);
                    if (!sfDoc.exists()) throw "Doc missing";
                    const data = sfDoc.data();
                    if (data.currentBuzzer !== null) throw "Too late"; 

                    const future = new Date();
                    future.setSeconds(future.getSeconds() + 32); 

                    transaction.update(roomRef, {
                        currentBuzzer: currentUser.uid,
                        buzzerTime: serverTimestamp(),
                        answerEndTime: future
                    });
                });
            } catch (e) {
                console.log("Buzz failed:", e);
            }
        }
        // Initial attachment not strictly needed as renderGame overwrites, but good practice
        // document.getElementById('btn-buzz').addEventListener('click', onBuzzClick); // Removed to avoid dupes

        document.getElementById('btn-impossible').addEventListener('click', async () => {
             if (!currentRoomId || !roomState) return;
             if (roomState.impossibleVotes.includes(currentUser.uid)) return;

             const roomRef = getRoomRef(currentRoomId);
             await updateDoc(roomRef, {
                 impossibleVotes: arrayUnion(currentUser.uid)
             });
             
             // Check is now done automatically via renderRoom / snapshot logic
        });

        // Removed checkImpossibleCondition function as it's now integrated into renderRoom for safety

        // --- Calculator Logic (Fix 2: History & Backspace) ---
        window.game = {
            clearEquation: () => {
                equationHistory = [];
                cursorPos = 0;
                updateCalcState();
            },
            backspace: () => {
                if (cursorPos > 0) {
                    equationHistory.splice(cursorPos - 1, 1);
                    cursorPos--;
                    updateCalcState();
                }
            },
            moveCursor: (delta) => {
                let newPos = cursorPos + delta;
                if (newPos >= 0 && newPos <= equationHistory.length) {
                    cursorPos = newPos;
                    updateCalcState();
                }
            },
            // Fix 3: Handle equation click for cursor
            handleEquationClick: (e) => {
                // Prevent duplicate handling if we have both listeners, though unlikely to be an issue here
                // Simple logic: If we have tokens, find closest.
                
                // Determine clientX regardless of input type
                let clientX;
                if (e.changedTouches && e.changedTouches.length > 0) {
                    clientX = e.changedTouches[0].clientX;
                } else {
                    clientX = e.clientX;
                }

                const container = document.getElementById('current-equation-html');
                if (!container) return;
                
                const tokens = Array.from(container.querySelectorAll('.calc-token'));
                
                // If empty or no tokens, cursor is 0
                if (tokens.length === 0) {
                    cursorPos = 0;
                    updateCalcState();
                    return;
                }

                // Find closest token position
                let bestIdx = 0;
                let minDist = Infinity;

                // Check distance to "start" (before first token)
                const firstRect = tokens[0].getBoundingClientRect();
                const distToStart = Math.abs(clientX - firstRect.left);
                if (distToStart < minDist) {
                    minDist = distToStart;
                    bestIdx = 0;
                }

                // Check distance to "after" each token
                tokens.forEach((token, idx) => {
                    const rect = token.getBoundingClientRect();
                    const distToEnd = Math.abs(clientX - rect.right);
                    if (distToEnd < minDist) {
                        minDist = distToEnd;
                        bestIdx = idx + 1;
                    }
                });

                cursorPos = bestIdx;
                updateCalcState();
            }
        };

        window.addToEquation = (val, idx) => {
            equationHistory.splice(cursorPos, 0, { type: 'card', val: val, cardIdx: idx });
            cursorPos++;
            updateCalcState();
        };

        document.querySelectorAll('.op-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                equationHistory.splice(cursorPos, 0, { type: 'op', val: btn.dataset.val });
                cursorPos++;
                updateCalcState();
            });
        });

        function updateCalcState() {
            // Rebuild string and used indices from history
            equationString = equationHistory.map(item => item.val).join('');
            usedCardsIndices = equationHistory
                .filter(item => item.type === 'card')
                .map(item => item.cardIdx);
            
            // Build visual representation with cursor
            const htmlContainer = document.getElementById('current-equation-html');
            if (htmlContainer) {
                htmlContainer.innerHTML = '';
                
                // Add start cursor if pos 0
                if (cursorPos === 0) {
                    const cursor = document.createElement('span');
                    cursor.className = 'equation-cursor';
                    htmlContainer.appendChild(cursor);
                }

                equationHistory.forEach((item, index) => {
                    const span = document.createElement('span');
                    span.innerText = item.val;
                    span.className = 'calc-token ' + (item.type === 'card' ? 'text-yellow-300 font-bold mx-1' : 'text-white mx-1');
                    
                    htmlContainer.appendChild(span);

                    // Add cursor after this item if position matches
                    if (index + 1 === cursorPos) {
                        const cursor = document.createElement('span');
                        cursor.className = 'equation-cursor';
                        htmlContainer.appendChild(cursor);
                    }
                });
            }

            renderGame(roomState); // Re-render to update card visual states
        }

        document.getElementById('btn-submit').addEventListener('click', () => {
            if (usedCardsIndices.length !== 5) {
                handleRoundResult('wrong', currentUser.uid, equationString + " (少於5張牌)");
                return;
            }
            
            try {
                if (/[^0-9+\-*/().]/.test(equationString)) throw new Error("Invalid characters");
                
                const result = Function('"use strict";return (' + equationString + ')')();
                
                if (Math.abs(result - 60) < 0.0001) {
                    handleRoundResult('correct', currentUser.uid, equationString);
                } else {
                    // Fix 2: Wrong calculation -> direct penalty
                    handleRoundResult('wrong', currentUser.uid, equationString);
                }
            } catch (e) {
                // Fix 2: Format error -> direct penalty
                handleRoundResult('wrong', currentUser.uid, equationString);
            }
        });

        function showToast(msg) {
            const m = document.getElementById('modal-msg');
            document.getElementById('modal-text').innerText = msg;
            m.classList.remove('hidden');
            setTimeout(() => m.classList.add('hidden'), 2000);
        }

        // --- Result Handling (Host Driven) ---
        async function handleRoundResult(type, playerId, equation = "") {
            const roomRef = getRoomRef(currentRoomId);
            const docSnap = await getDoc(roomRef);
            const data = docSnap.data();
            let players = [...data.players];
            
            if (type === 'correct') {
                const pIndex = players.findIndex(p => p.id === playerId);
                if(pIndex >=0) players[pIndex].score += 1;
            } else if (type === 'wrong' || type === 'timeout') {
                const pIndex = players.findIndex(p => p.id === playerId);
                if(pIndex >=0) {
                    players[pIndex].score -= 1;
                    if (players[pIndex].score <= 0) players[pIndex].status = 'eliminated';
                }
            }

            await updateDoc(roomRef, {
                status: 'replay',
                lastResult: { type, playerId, equation },
                players: players
            });
        }

        // --- Replay Animation Logic ---
        function playReplay(data) {
            const { type, playerId, equation } = data.lastResult;
            const container = document.getElementById('replay-cards-container');
            const eqDiv = document.getElementById('replay-equation');
            const stamp = document.getElementById('replay-stamp');
            const pInfo = document.getElementById('replay-player-info');
            
            container.innerHTML = '';
            eqDiv.innerText = '';
            stamp.className = 'opacity-0';
            stamp.innerText = '';
            
            data.cards.forEach(val => {
                const card = document.createElement('div');
                card.className = "playing-card w-12 h-16 text-lg rounded bg-white text-black flex items-center justify-center font-bold shadow-lg";
                card.innerText = val === 1 ? 'A' : val;
                container.appendChild(card);
            });

            if (playerId) {
                const p = data.players.find(user => user.id === playerId);
                pInfo.innerHTML = `<i class="fa-solid fa-user"></i> ${p ? p.name : 'Unknown'}`;
            } else {
                pInfo.innerHTML = "無人作答 / 題目無解";
            }

            let textToShow = (type === 'impossible') ? "NO SOLUTION FOUND" : (equation || "TIMEOUT");
            let i = 0;
            eqDiv.innerHTML = '';
            
            const typeTimer = setInterval(() => {
                if(!document.getElementById('replay-equation')) {
                    clearInterval(typeTimer);
                    return;
                }
                
                if (i < textToShow.length) {
                    eqDiv.innerHTML += textToShow.charAt(i);
                    i++;
                } else {
                    clearInterval(typeTimer);
                    setTimeout(() => {
                        stamp.classList.remove('opacity-0');
                        stamp.classList.add('animate-stamp');
                        if (type === 'correct') {
                            stamp.className = 'stamp-correct absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl rotate-[-10deg] animate-stamp';
                            stamp.innerText = "ANSWER CORRECT";
                        } else if (type === 'wrong') {
                            stamp.className = 'stamp-wrong absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl rotate-[-10deg] animate-stamp';
                            stamp.innerText = "WRONG";
                        } else if (type === 'timeout') {
                            stamp.className = 'stamp-wrong absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl rotate-[-10deg] animate-stamp';
                            stamp.innerText = "TIME OUT";
                        } else {
                            stamp.className = 'text-gray-400 font-bold text-2xl border-4 border-gray-400 p-2 rounded absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 animate-stamp';
                            stamp.innerText = "SKIPPED";
                        }
                    }, 300);
                }
            }, 50); 
        }

        // --- Helper Views ---
        function showView(viewId) {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewId].classList.remove('hidden');
        }

    </script>
</body>
</html>
